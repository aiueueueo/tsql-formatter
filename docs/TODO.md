# T-SQL Formatter 開発TODOリスト

## Phase 1: 初期リリース

### 1. プロジェクトセットアップ ✅

- [x] Visual Studio ソリューション作成（.NET Framework 4.8 / VSIX プロジェクト）
- [x] Git リポジトリ初期化
- [x] .gitignore 作成
- [x] ディレクトリ構成作成
  - [x] src/Core/
  - [x] src/UI/
  - [x] src/Settings/
  - [x] src/Plugin/
  - [x] tests/

### 2. 依存関係のインストール ✅

- [x] NuGet パッケージ追加
  - [x] Microsoft.SqlServer.DacFx（ScriptDom含む）
  - [x] Newtonsoft.Json（設定ファイル用）
  - [ ] SSMS 拡張SDK（SSMS 22対応）※Phase 9で対応
- [x] 参照設定の確認

### 3. コア機能: SQLパーサー ✅

- [x] ScriptDom ラッパークラス作成
  - [x] SQL文字列 → AST 変換
  - [x] 構文エラー検出機能
  - [x] エラー時は元のSQLを返す処理
- [x] SqlScriptGenerator 作成（AST → SQL文字列）
- [x] パーサーのユニットテスト作成（29テスト）

### 4. コア機能: フォーマットルールエンジン ✅

- [x] ルール基底クラス/インターフェース設計
- [x] FormattingVisitor 実装（TSqlFragmentVisitor継承）
- [x] 個別ルール実装
  - [x] キーワード大文字化ルール
  - [x] インデント（タブ）ルール
  - [x] カンマ行頭配置ルール
  - [x] 句ごと改行ルール（SELECT, FROM, WHERE等）
  - [x] ORDER BY句のフォーマット処理
  - [x] JOIN句独立行ルール
  - [x] ON句インデントルール
  - [x] サブクエリインデントルール
  - [x] CASE文フォーマットルール
  - [x] 演算子スペースルール
  - [x] 括弧スペースルール（スペースなし）
  - [x] ASキーワード強制ルール
  - [ ] コメント位置保持ルール（部分対応）
- [x] ルール適用エンジン作成
- [x] 各ルールのユニットテスト作成（52テスト）

### 5. コア機能: フォーマッター本体 ✅

- [x] Formatter クラス作成
  - [x] 入力SQL → パース → ルール適用 → 出力SQL
  - [x] 設定に基づくルール切り替え
- [x] 複合テストケース作成
  - [x] 単純なSELECT文
  - [x] JOIN付きSELECT文
  - [x] サブクエリ付きSELECT文
  - [x] INSERT文
  - [x] UPDATE文
  - [x] DELETE文
  - [ ] CREATE TABLE文
  - [ ] ストアドプロシージャ
  - [ ] 複数ステートメント
  - [ ] コメント付きSQL

### 6. 設定管理 ✅

- [x] 設定モデルクラス作成（FormatterSettings）
- [x] JSON シリアライズ/デシリアライズ
- [x] 設定ファイル読み込み
  - [x] プロジェクト設定（.sqlformatter.json）
  - [x] 個人設定（%APPDATA%）
  - [x] ハイブリッド優先度処理
- [x] デフォルト設定定義
- [ ] 設定管理のユニットテスト

### 7. プリセット機能 ✅

- [x] プリセットモデルクラス作成
- [x] 組み込みプリセット作成
  - [x] Default（仕様書通り）
  - [x] Compact（コンパクト表示）
- [x] カスタムプリセット保存/読み込み
- [ ] プリセット切り替え機能

### 8. UI: 設定画面（WPF）✅

- [x] SettingsWindow.xaml 作成
- [x] ViewModel 作成（MVVM）
- [x] 各設定項目のUI
  - [x] インデント設定（タブ/スペース、幅）
  - [x] キーワードケース設定
  - [x] カンマ位置設定
  - [x] 改行設定
  - [x] 演算子スペース設定
  - [x] ASキーワード強制設定
- [x] プリセット選択/管理UI
- [x] ショートカットキー設定UI
- [x] 適用範囲設定UI
- [x] プレビュー機能（リアルタイムフォーマット確認）
- [x] 保存/キャンセルボタン
- [ ] UI のテスト

### 9. SSMS統合 ✅

- [x] SSMS拡張機能プロジェクト設定
- [x] コマンド登録（メニュー/ショートカット）
  - [x] フォーマット実行コマンド
  - [x] 設定画面表示コマンド
- [x] エディタテキスト取得/置換処理
- [x] ショートカットキーバインド（Ctrl+K）
- [x] 適用範囲処理（全体/選択範囲）
- [ ] SSMS上での動作テスト

### 10. エラーハンドリング ✅

- [x] 構文エラー時のユーザー通知
- [x] 例外処理とログ出力
- [x] ユーザーフレンドリーなエラーメッセージ

### 11. テスト

- [ ] ユニットテスト全体実行確認
- [ ] 統合テスト
- [ ] SSMS上での手動テスト
  - [ ] 各種SQLパターン
  - [ ] ショートカットキー動作
  - [ ] 設定画面動作
  - [ ] 設定の保存/読み込み
- [ ] ORDER BY関連の追加テスト（レビュー指摘）
  - [ ] サブクエリ内のORDER BY句のインデント確認
  - [ ] テストアサーションの厳密化（完全な出力文字列との比較）
  - [ ] エッジケースのテスト追加（UNION、TOP、OFFSET/FETCH等）

### 12. ドキュメント

- [ ] README.md 作成
- [ ] インストール手順書
- [ ] 使用方法ガイド
- [ ] 設定項目リファレンス

### 13. ビルド・配布

- [ ] Release ビルド設定
- [ ] インストーラー/VSIX パッケージ作成
- [ ] 社内配布用パッケージ準備
- [ ] バージョン管理方針決定

---

## Phase 2: Linter機能（将来）

### 14. DB接続機能

- [ ] SSMS接続情報取得
- [ ] スキーマ情報取得機能
- [ ] 接続設定UI

### 15. Linterルール

- [ ] テーブル修飾子自動付与
- [ ] その他のLinterルール（未定）

### 16. Linter UI

- [ ] 警告/提案表示UI
- [ ] 自動修正機能

---

## 進捗管理

| フェーズ | 項目数 | 完了 | 進捗率 |
|----------|--------|------|--------|
| Phase 1  | 13セクション | 10 | 77% |
| Phase 2  | 3セクション | - | - |

---

## 備考

- 優先度が高い順に並べている
- 各セクション内のタスクも上から順に実施推奨
- テストは機能実装と並行して作成する
- Phase 2 は Phase 1 完了後に詳細化する
